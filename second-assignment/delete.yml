---
  - name: "Destroying a GCP Compute Engine Instance Template"
    hosts: localhost
    connection: local
    tasks:

    - name: Delete a network
      google.cloud.gcp_compute_network:
        name: network-instancetemplate
        auto_create_subnetworks: 'true'
        project: "live-person-332313"
        auth_kind: "serviceaccount"
        service_account_file: "./gkecluster-keyfile.json"
        state: absent
      register: network

    - name: Delete an address
      google.cloud.gcp_compute_address:
        name: address-instancetemplate
        region: us-central1
        project: "live-person-332313"
        auth_kind: "serviceaccount"
        service_account_file: "./gkecluster-keyfile.json"
        state: absent
      register: address

  
    - name: Delete a disk for new instance
      google.cloud.gcp_compute_disk:
        name: "disk-instancetemplate"
        size_gb: "200"
        source_image: "projects/centos-cloud/global/images/centos-7-v20211105"
        zone: "us-central1-a"
        project: "live-person-332313"
        auth_kind: "serviceaccount"
        service_account_file: "./gkecluster-keyfile.json"
        state: absent
      register: disk
  
    - name: Delete the instance template
      google.cloud.gcp_compute_instance_template:
        name: "instance-template"
        properties:
          disks:
          - auto_delete: 'true'
            type: PERSISTENT
            boot: 'true'
            source: "{{ disk }}"
          machine_type: "c2-standard-8"
          metadata:
            startup-script-url: gs://live-person-test/startup_script.sh
          network_interfaces:
          - network: "{{ network }}"
            access_configs:
            - name: test-config
              type: ONE_TO_ONE_NAT
              nat_ip: "{{ address }}"
        project: "live-person-332313"
        auth_kind: serviceaccount
        service_account_file: "./gkecluster-keyfile.json"
        state: absent
